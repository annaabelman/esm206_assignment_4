---
title: "ESM206 Assignment 4"
author: "Anna Abelman and Emma Friedl"
date: "11/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, message=FALSE}
#Attaching Packages
library(tidyverse)
library(janitor)
library(here)
library(DT)
library(knitr)
library(kableExtra)

# Read in data
lobster <- read_csv(here("raw_data", "lobster_abundance_sbc_lter.csv"),
                    na = "-99999") %>% 
  clean_names()
```

```{r}
lobster_tidy <- lobster %>% 
  uncount(count)
```


# Introduction:

# Data Methods

# Results:

## A.

Naples and IV are MPA. They were established in 2012
```{r}
lobster_site <- lobster_tidy %>% 
  group_by(year)%>% 
  count(site) %>% 
  mutate(highlight = ifelse(site == "IVEE" | site == "NAPL", "MPA", "Non-MPA"))

  ggplot(data = lobster_site, aes(x = year, y = n, group = site, color = highlight)) +
  geom_line(aes(color = highlight,
                linetype = highlight,
                size = highlight),
            show.legend = FALSE)+
    scale_color_manual(values = c("firebrick3", "dimgray"))+
    scale_size_manual(values = c(1.5,1))+
    scale_linetype_manual(values = c("solid", "dotted"))+
  theme_minimal()+
    theme(plot.title = element_text(hjust = 0.5))+
  labs(x = "Year",
       y = "Number of Lobsters",
       title = "Population Size of Lobsters at Each Site, 2012-2018")+
    scale_x_continuous(expand = c(0,0))+
    theme(plot.margin = margin(4, 4, 4, 4, "mm")) +
    annotate(geom = "text",
           x = 2017.2,
           y = 800,
           size = 2.7,
           label = "Isla Vista",
           color = "firebrick3", 
           fontface = 2)+
      annotate(geom = "text",
           x = 2017.65,
           y = 605,
           size = 2.7,
           label = "Carpinteria",
           color = "dimgrey", 
           fontface = 2)+
    annotate(geom = "text",
           x = 2017.7,
           y = 300,
           size = 2.7,
           label = "Naples",
           color = "firebrick3", 
           fontface = 2)+
     annotate(geom = "text",
           x = 2016.85,
           y = 230,
           size = 2.7,
           label = "Mohawk",
           color = "dimgrey", 
           fontface = 2)+
    annotate(geom = "text",
           x = 2017.5,
           y = 90,
           size = 2.7,
           label = "Arroyo Quemado",
           color = "dimgrey", 
           fontface = 2)
    
```
**Figure 1**: Change in Lobster abundance from 2012-2018 for all five sites: Isla Vista, Carpinteria, Mohawk, Naples, and Arroyo Quemado. MPA sites (red, solid lines) slightly increased in lobster population size, while Non-MPA sites' (gray, dotted line) lobster population size varied based on site. Data from SBC LTER.

## B. Lobster Size Distributions by Site and Year 
```{r}
lobster_size <- lobster_tidy %>%
  select(year, site, size_mm) %>% 
  filter(year %in% c("2012","2018"))

lobster_size$year <- as.factor(lobster_size$year)

lobster_size$site[lobster_size$site == "AQUE"] <- "Arroyo Quemado"
lobster_size$site[lobster_size$site == "CARP"] <- "Carpinteria"
lobster_size$site[lobster_size$site == "IVEE"] <- "Isla Vista"
lobster_size$site[lobster_size$site == "MOHK"] <- "Mohawk"
lobster_size$site[lobster_size$site == "NAPL"] <- "Naples"

#make a faceted violin plot comparing 
#all five sites by year
 ggplot(lobster_size, aes(x = year, y = size_mm, fill = year)) +
   scale_fill_manual(values = c("#038c8c", "#f2955e")) +
  geom_violin(position = "dodge", show.legend = FALSE, trim = FALSE) +
   stat_summary(fun.y = mean, geom = "point", color = "black", shape = 8, size = 2, show.legend = FALSE) +
  facet_wrap(~site, scales = "free") +
   coord_flip() +
   scale_y_continuous(expand = c(0,0)) +
   scale_x_discrete(limits = c(2018, 2012), labels = TRUE) +
   labs(y = "Mean Size (mm)",
        title = "California Spiny Lobster Size Distribution by Site, 2012 & 2018") +
   theme(plot.title = element_text(hjust = 0.5)) +
   theme(axis.title.y = element_blank())
  
```
**Figure 2.** California Spiny Lobster size distribution (mm) at 2 Marine Protected Sites (Isla Vista and Naples) and 3 outside sites (Arroyo Quemado, Mohawk and Carpinteria) at 2012 and 2018. Mean sizes of each sample are shown as a black star. Non-MPA sites do not show a consistent difference between years, while both MPA sites show an increase in larger lobster sizes from 2012 (orange-red) to 2018 (green). Data: Santa Barbara Coastal LTER.

For Non-MPA sites, the changes in size distributions from 2012 to 2018 vary. At Arroyo Quemado in 2012, lobster sizes were concentrated at the low end around 65mm. In 2018, there were still a similar number of lobsters around 65mm, but also a comparable proportion at larger sizes from 70-80mm, signifying an overall increase in larger lobsters over the studied time period, despite an unchanged mean. Carpinteriaâ€™s lobster sizes were slightly more concentrated in 2018, but the largest proportion of lobster sizes remained around 70mm for each year, indicating little change in average lobster size. Finally, the Mohawk site had a more positively skewed distribution in 2012 but a more negatively skewed one in 2018. While the bulk of measurements lay around 75mm in both years, average lobster size decreased. Overall, there is no consistent pattern in size distributions over time between the Non-MPA sites.

MPA sites, however, show a different story. In Isla Vista, most lobster sizes were concentrated around 60mm in 2012 and 85mm in 2018. The mean also increased significantly. At the Naples site in 2012, the largest proportion of lobster sizes was around 65mm, but in 2018 the highest concentration was in the 75-85mm range. The mean also increased here. While actual lobster sizes varied, the distributions indicate that there were higher concentrations of lobster sizes at higher values in 2018, indicating an overall increase in average lobster size at MPA designated sites. These findings suggest that the MPA designation had a positve effect on lobster size.


## C. Comparing Mean Size Values by Protected Status and Year
```{r}
#create a vector containing either "MPA" or "Non_MPA"
#corresponsing to the site
sites = lobster_tidy$site
mpa_sites <- ifelse(sites == "IVEE" | sites == "NAPL", 
                    "MPA", "Non_MPA")

lobster_mean_size <- lobster_tidy %>% 
  mutate(protected_status = mpa_sites) %>% 
  select(year, size_mm, protected_status) %>% 
  filter(year == c("2012","2018")) %>% 
  group_by(protected_status, year) %>% 
  mutate(mean_size = mean(size_mm, na.rm = TRUE) %>% round(2)) 

lobster_mean_size$year <- as.factor(lobster_mean_size$year)

ggplot(lobster_mean_size, 
       aes(fill = year, x = protected_status, y = mean_size)) +
   theme(legend.position = "none") +
  scale_fill_manual(values = c("#038c8c", "#f2955e")) +
  geom_col(position="dodge") +
  labs(y = "Mean Size (mm)",
       title = "TITLE") +
   theme(axis.title.x = element_blank()) +
  scale_x_discrete(expand = c(0,0)) +
  geom_text(aes(label = mean_size), position = position_dodge(width = 0.9), vjust = -0.25) +
  geom_text(aes(label = mean_size), position = position_dodge(width = 0.9), vjust = -0.25) +
  annotate("text", x = c(.77, 1.77), y = 3, label = "2012") + annotate("text", x = c(1.22, 2.22), y = 3, label = "2018")

```
**Figure 3** CAPTION

Maybe some light analysis here... percentages?

**Table 1.**

```{r}
#mean statistics
lobster_table <- lobster_tidy %>% 
  mutate(protected_status = mpa_sites) %>%
  filter(year == c("2012","2018")) %>% 
  group_by(protected_status, year) %>% 
  summarize(
    mean = mean(size_mm, na.rm = TRUE) %>% round(2),
    sd = sd(size_mm, na.rm = TRUE) %>% round(2),
    count = n()
  )

kable(lobster_table, col.names = c("Protected Status", "Year", "Mean (mm)", "Standard Deviation (mm)", "Count")) %>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = F,
                position = "left")
#add title
  

#2012 mpa vs non mpa - ttest
lobster_2012_mpa <- lobster_mean_size %>% 
 filter(year == "2012" & protected_status == "MPA") %>% 
  pull(size_mm)

lobster_2012_non <- lobster_mean_size %>% 
  filter(year == "2012" & 
           protected_status == "Non_MPA") %>% 
  pull(size_mm)

mpa_vs_non_2012 <- t.test(lobster_2012_mpa, lobster_2012_non)

#2018 mpa vs non - ttest
lobster_2018_mpa <- lobster_mean_size %>% 
  filter(year == "2018" & protected_status == "MPA") %>% 
  pull(size_mm)

lobster_2018_non <- lobster_mean_size %>% 
  filter(year == "2018", protected_status == "Non_MPA") %>%  pull(size_mm)

mpa_vs_non_2018 <- t.test(lobster_2018_mpa, lobster_2018_non)

#MPA 2012 vs 2018 - ttest
mpa_12_vs_18 <- t.test(lobster_2012_mpa, lobster_2018_mpa)

#Non_MPA 2012 vs 2018 - ttest
non_12_vs_18 <- t.test(lobster_2012_non, lobster_2018_non)

```
Stat analysis

In 2012, mean lobster sizes at MPA sites were `r ` % higher than at Non MPA sites (XXXX at MPA, and XXX at Non MPA) 

Mean sizes at MPA (mean +/- Standard Deviation, n = XXX), differed significantly from mean sizes at Non MPA(stats) by a paired two-sample t test(stats)

In analysis, talk about what cohen's d means for validity 

# Summary:


# References:

Reed D. 2019. SBC LTER: Reef: Abundance, size and fishing effort for California Spiny Lobster (Panulirus interruptus), ongoing since 2012. Environmental Data Initiative. https://doi.org/10.6073/pasta/a593a675d644fdefb736750b291579a0. Dataset accessed 11/09/2019.










